version: "3.9"
services:
  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped
    ports: ["80:80","443:443"]
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on: [backend, frontend]

  backend:
    image: ghcr.io/REPLACE_GH_USER/carizon-backend:latest
    container_name: backend
    env_file: [./.env.backend]
    restart: unless-stopped

  frontend:
    image: ghcr.io/REPLACE_GH_USER/carizon-frontend:latest
    container_name: frontend
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_DATABASE: appdb
      MYSQL_USER: app
      MYSQL_PASSWORD: app_pw
      MYSQL_ROOT_PASSWORD: root_pw
    volumes: ["mysqldata:/var/lib/mysql"]
    restart: unless-stopped

  opensearch:
    image: opensearchproject/opensearch:2.13.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits: { memlock: { soft: -1, hard: -1 } }
    ports: ["9200:9200"]
    volumes: ["osdata:/usr/share/opensearch/data"]
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports: ["6379:6379"]

  crawler:
    image: ghcr.io/REPLACE_GH_USER/carizon-crawler:latest
    container_name: crawler
    env_file: [./.env.crawler]
    depends_on: [mysql]
    restart: unless-stopped

volumes:
  mysqldata:
  osdata:
  caddy_data:
  caddy_config:
